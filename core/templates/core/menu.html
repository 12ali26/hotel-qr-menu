<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ hotel.name }} - Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        /* Simple scrollbar styling for a more modern look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* dark:bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* dark:bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* dark:bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans" x-data="menuApp()">

    <!-- Sticky Header -->
    <header class="sticky top-0 z-50 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm shadow-md">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-900 dark:text-white truncate">{{ hotel.name }}</h1>
                    {% if location %}
                        <p class="text-sm text-gray-600 dark:text-gray-400">{{ hotel.get_location_label }} {{ location }}</p>
                    {% endif %}
                </div>
                <div class="flex items-center space-x-3">
                    {% if hotel.enable_waiter_alerts %}
                    <!-- Call Waiter Button (Restaurant) -->
                    <button @click="callWaiter()" class="p-2 rounded-full bg-blue-500 hover:bg-blue-600 text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                    </button>
                    {% endif %}
                    <!-- Cart -->
                    <div class="relative">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-gray-700 dark:text-gray-300 cursor-pointer" fill="none" viewBox="0 0 24 24" stroke="currentColor" @click="showCart = !showCart">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                        <!-- Cart count badge -->
                        <span x-show="cart.length > 0" class="absolute -top-2 -right-2 flex items-center justify-center h-5 w-5 bg-red-500 text-white text-xs rounded-full" x-text="cart.length">0</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto p-4">
        {% for category in categories %}
            <section id="category-{{ category.id }}" class="mb-8">
                <h2 class="text-2xl font-extrabold text-gray-900 dark:text-white mb-4 border-l-4 border-amber-500 pl-3">{{ category.name }}</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {% for item in category.menu_items.all %}
                        {% if item.is_available %}
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col transform hover:scale-105 transition-transform duration-300">
                            {% if item.image %}
                                <img src="{{ item.image.url }}" alt="{{ item.name }}" class="w-full h-48 object-cover">
                            {% else %}
                                <div class="w-full h-48 bg-gray-200 dark:bg-gray-700 flex items-center justify-center">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-400 dark:text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h16" />
                                    </svg>
                                </div>
                            {% endif %}
                            
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">{{ item.name }}</h3>
                                <p class="text-gray-600 dark:text-gray-400 text-sm mt-1 flex-grow">{{ item.description|default:"No description available." }}</p>

                                <div class="mt-3 flex items-center justify-between">
                                    <p class="text-xl font-bold text-amber-600 dark:text-amber-500">
                                        {{ item.price|floatformat:2 }}
                                        <span class="text-sm font-normal text-gray-500 dark:text-gray-400">{{ hotel.currency_code }}</span>
                                    </p>
                                    <button @click="addToCart({{ item.id }}, '{{ item.name }}', {{ item.price }})" class="bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition-colors duration-300">
                                        Add
                                    </button>
                                </div>
                                <div class="mt-3 text-xs text-gray-500 dark:text-gray-400">
                                    {% if item.is_vegetarian %}<span class="font-semibold text-green-600 dark:text-green-400">ðŸŒ± Vegetarian</span>{% endif %}
                                    {% if item.is_vegan %} <span class="font-semibold text-green-600 dark:text-green-400">ðŸŒ¿ Vegan</span>{% endif %}
                                    {% if item.is_gluten_free %} <span class="font-semibold text-blue-600 dark:text-blue-400">ðŸŒ¾ Gluten-Free</span>{% endif %}
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    {% empty %}
                        <div class="col-span-full text-center py-8 bg-white dark:bg-gray-800 rounded-lg shadow">
                            <p class="text-gray-500 dark:text-gray-400">No items available in this category at the moment.</p>
                        </div>
                    {% endfor %}
                </div>
            </section>
        {% empty %}
            <div class="text-center py-16">
                <h2 class="text-2xl font-semibold text-gray-700 dark:text-gray-300">Menu Coming Soon</h2>
                <p class="text-gray-500 dark:text-gray-400 mt-2">The menu for {{ hotel.name }} is currently being updated. Please check back later.</p>
            </div>
        {% endfor %}
    </main>

    <!-- Cart Sidebar -->
    <div x-show="showCart" @click.away="showCart = false" x-transition class="fixed inset-y-0 right-0 w-full md:w-96 bg-white dark:bg-gray-800 shadow-2xl z-50 overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Your Order</h2>
                <button @click="showCart = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <div x-show="cart.length === 0" class="text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                </svg>
                <p class="text-gray-500 dark:text-gray-400 mt-4">Your cart is empty</p>
            </div>

            <div x-show="cart.length > 0">
                <!-- Cart Items -->
                <div class="space-y-4 mb-6">
                    <template x-for="item in cart" :key="item.id">
                        <div class="flex justify-between items-center bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                            <div class="flex-1">
                                <h3 class="font-semibold text-gray-900 dark:text-white" x-text="item.name"></h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400" x-text="'{{ hotel.currency_code }} ' + item.price.toFixed(2)"></p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <button @click="updateQuantity(item.id, -1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center justify-center">
                                    <span class="text-lg font-bold">-</span>
                                </button>
                                <span class="font-semibold w-8 text-center" x-text="item.quantity"></span>
                                <button @click="updateQuantity(item.id, 1)" class="w-8 h-8 rounded-full bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-500 flex items-center justify-center">
                                    <span class="text-lg font-bold">+</span>
                                </button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- Special Requests -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Special Requests</label>
                    <textarea x-model="specialRequests" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white" placeholder="Any special instructions?"></textarea>
                </div>

                <!-- Total -->
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600 dark:text-gray-400">Subtotal</span>
                        <span class="font-semibold" x-text="'{{ hotel.currency_code }} ' + getSubtotal().toFixed(2)"></span>
                    </div>
                    <div class="flex justify-between mb-2">
                        <span class="text-gray-600 dark:text-gray-400">Tax (5%)</span>
                        <span class="font-semibold" x-text="'{{ hotel.currency_code }} ' + getTax().toFixed(2)"></span>
                    </div>
                    <div class="flex justify-between text-lg font-bold">
                        <span>Total</span>
                        <span class="text-amber-600 dark:text-amber-500" x-text="'{{ hotel.currency_code }} ' + getTotal().toFixed(2)"></span>
                    </div>
                </div>

                <!-- Payment Method (if hotel supports room charging) -->
                {% if hotel.enable_room_charging %}
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Payment Method</label>
                    <select x-model="paymentMethod" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        <option value="CARD">Pay with Card</option>
                        <option value="ROOM_CHARGE">Charge to {{ hotel.get_location_label }}</option>
                    </select>
                </div>
                {% endif %}

                <!-- Place Order Button -->
                <button @click="placeOrder()" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-bold py-4 rounded-lg transition-colors duration-300">
                    Place Order
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div x-show="notification.show" x-transition class="fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50">
        <p x-text="notification.message"></p>
    </div>

    <script>
        function menuApp() {
            return {
                cart: [],
                showCart: false,
                specialRequests: '',
                paymentMethod: 'CARD',
                notification: {
                    show: false,
                    message: ''
                },

                addToCart(id, name, price) {
                    const existingItem = this.cart.find(item => item.id === id);
                    if (existingItem) {
                        existingItem.quantity++;
                    } else {
                        this.cart.push({
                            id: id,
                            name: name,
                            price: parseFloat(price),
                            quantity: 1
                        });
                    }
                    this.showNotification('Added to cart!');
                },

                updateQuantity(id, change) {
                    const item = this.cart.find(item => item.id === id);
                    if (item) {
                        item.quantity += change;
                        if (item.quantity <= 0) {
                            this.cart = this.cart.filter(i => i.id !== id);
                        }
                    }
                },

                getSubtotal() {
                    return this.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                },

                getTax() {
                    return this.getSubtotal() * 0.05;
                },

                getTotal() {
                    return this.getSubtotal() + this.getTax();
                },

                async callWaiter() {
                    try {
                        const response = await fetch('{% url "waiter_alert" hotel.slug %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                location: '{{ location }}'
                            })
                        });

                        if (response.ok) {
                            this.showNotification('Waiter has been notified!');
                        } else {
                            this.showNotification('Failed to call waiter. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error calling waiter:', error);
                        this.showNotification('An error occurred. Please try again.');
                    }
                },

                async placeOrder() {
                    if (this.cart.length === 0) {
                        this.showNotification('Your cart is empty!');
                        return;
                    }

                    try {
                        const response = await fetch('{% url "place_order" hotel.slug %}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': this.getCookie('csrftoken')
                            },
                            body: JSON.stringify({
                                location: '{{ location }}',
                                items: this.cart,
                                special_requests: this.specialRequests,
                                payment_method: this.paymentMethod
                            })
                        });

                        const data = await response.json();

                        if (response.ok) {
                            this.showNotification('Order placed successfully!');
                            this.cart = [];
                            this.specialRequests = '';
                            this.showCart = false;

                            // Optionally redirect to order confirmation page
                            if (data.order_id) {
                                setTimeout(() => {
                                    window.location.href = `/order/${data.order_id}/`;
                                }, 2000);
                            }
                        } else {
                            this.showNotification(data.error || 'Failed to place order. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error placing order:', error);
                        this.showNotification('An error occurred. Please try again.');
                    }
                },

                showNotification(message) {
                    this.notification.message = message;
                    this.notification.show = true;
                    setTimeout(() => {
                        this.notification.show = false;
                    }, 3000);
                },

                getCookie(name) {
                    let cookieValue = null;
                    if (document.cookie && document.cookie !== '') {
                        const cookies = document.cookie.split(';');
                        for (let i = 0; i < cookies.length; i++) {
                            const cookie = cookies[i].trim();
                            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                                break;
                            }
                        }
                    }
                    return cookieValue;
                }
            }
        }
    </script>
</body>
</html>
